<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prieres des Heures (AELF)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
        }
        
        body { 
            background-color: var(--light-color); 
            font-family: 'Georgia', serif;
            padding-top: 1rem;
        }
        
        .container { 
            max-width: 100%;
            padding: 0 15px;
        }
        
        .card { 
            border-radius: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .card-header {  
            height: 50vh;
        }
        
        /* Navigation tabs */
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
        }
        
        .nav-tabs .nav-link { 
            color: var(--secondary-color); 
            font-weight: 500; 
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .nav-tabs .nav-link.active { 
            color: var(--primary-color); 
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* Prayer content */
        .prayer-section { 
            padding: 1rem; 
            background: white; 
            border-radius: 0 0 15px 15px; 
            font-size: 0.95rem;
        }
        
        .prayer-title { 
            color: var(--primary-color); 
            margin-bottom: 1rem; 
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .prayer-subtitle { 
            color: var(--secondary-color); 
            font-size: 1rem; 
            margin: 0.5rem 0;
        }
        
        .verse { 
            font-style: italic; 
            color: var(--secondary-color); 
            margin-left: 1rem;
            font-size: 0.9rem;
        }
        
        .reference { 
            color: #28a745; 
            font-size: 0.85rem;
        }
        
        /* Form elements */
        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
        }
        
        .btn {
            padding: 0.375rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .card-header {
                padding: 1rem;
            }
            
            .d-flex {
                flex-direction: column;
                gap: 0.5rem !important;
            }
            
            .d-flex > * {
                width: 100% !important;
            }
            
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .prayer-section {
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }
            
            .card {
                border-radius: 10px;
            }
            
            .prayer-title {
                font-size: 1.1rem;
            }
            
            .verse {
                margin-left: 0.5rem;
            }
        }

        /* AUJOURD'HUI */
        /* Conteneur principal */
        .controls-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Styles communs pour les champs */
        .date-field,
        .zone-selector {
            flex: 1 1 auto;
            min-width: 150px;
        }

        /* Adaptation responsive */
        @media (max-width: 992px) {
            .date-field,
            .zone-selector {
                width: 100%;
                max-width: 100%;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        @media (min-width: 768px) and (max-width: 992px) {
            .controls-container > div {
                flex-wrap: wrap;
            }
            
            .date-field,
            .zone-selector {
                flex: 0 0 calc(50% - 12px);
            }
        }

        /* Styles spécifiques */
        .input-group-text {
            transition: all 0.3s ease;
            border-right: none !important;
        }
        
        .form-control,
        .form-select {
            border-left: none !important;
            transition: all 0.3s ease;
        }
        
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
        
        .action-btn {
            padding-left: 2rem;
            padding-right: 2rem;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4) !important;
        }
        
        /* Animation pour les petits écrans */
        @media (max-width: 576px) {
            .btn-text {
                display: inline-block;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        }
    </style>
</head>
<body>
    <div class="container py-3 py-md-5">
        <div class="card shadow-lg border-0 overflow-hidden">
            <!-- En-tête avec image de fond et overlay -->
            <div class="card-header text-center text-white p-0 position-relative" style="background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1544830287-45b4c3c1c326?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') center/cover; min-height: 200px;">
                <div class="position-absolute top-50 start-50 translate-middle w-100 px-3">
                    <!-- Logo -->
                    <div class="mb-3">
                        <img src="https://via.placeholder.com/80x80?text=NDR" alt="Logo Paroisse" class="rounded-circle border border-3 border-white" style="width: 80px; height: 80px; object-fit: cover;">
                    </div>
                    
                    <!-- Titres avec animation -->
                    <h1 class="h2 h1-md mb-2 fw-bold text-uppercase" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                        <span class="d-block animate__animated animate__fadeInDown">PAROISSE NOTRE DAME DU ROSAIRE</span>
                        <small class="d-block fs-5 animate__animated animate__fadeIn animate__delay-1s">MAMBANDA</small>
                    </h1>
                    
                    <h2 class="h4 mt-3 animate__animated animate__fadeIn animate__delay-1s">
                        <i class="fas fa-angel me-2"></i>Groupe des Enfants de Chœur
                    </h2>
                    
                    <h3 class="h5 text-warning mt-2 mb-4 animate__animated animate__fadeIn animate__delay-2s" style="font-family: 'Times New Roman', serif;">
                        « Prières des Heures »
                    </h3>
                    
                    <!-- Contrôles avec effet hover -->
                    <div class="controls-container">
                        <div class="d-flex flex-column flex-lg-row align-items-stretch justify-content-center gap-3">
                            <!-- Champ Date -->
                            <div class="input-group input-group-lg date-field">
                                <span class="input-group-text bg-white text-primary">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <input type="date" id="dateInput" class="form-control shadow-sm border-start-0">
                            </div>
                            
                            <!-- Sélecteur de Zone -->
                            <div class="input-group input-group-lg zone-selector">
                                <span class="input-group-text bg-white text-primary">
                                    <i class="fas fa-globe-africa"></i>
                                </span>
                                <select id="zoneInput" class="form-select shadow-sm border-start-0">
                                    <option value="afrique">Afrique</option>
                                    <option value="france">France</option>
                                </select>
                            </div>
                            
                            <!-- Bouton d'action -->
                            <button onclick="fetchPrayers()" class="btn btn-primary btn-lg action-btn shadow-sm">
                                <i class="fas fa-search me-2"></i>
                                <span class="btn-text">Afficher</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Corps de carte avec effet de transition -->
            <div class="card-body p-3 p-md-4 bg-light">
                <div id="results" class="transition-all"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Structure des données attendues pour chaque prière
        const PRAYER_STRUCTURE = {
            "Complies": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                cantique_symeon: { reference: "string", titre: "string", texte: "string" },
                oraison: "string",
                benediction: "string",
                hymne_mariale: { titre: "string", texte: "string" }
            },
            "Laudes": {
                introduction: "string",
                antienne_invitatoire: "string",
                psaume_invitatoire: { reference: "string", texte: "string" },
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                antienne_zacharie: "string",
                cantique_zacharie: { reference: "string", titre: "string", texte: "string" },
                intercession: "string",
                oraison: "string",
                notre_pere: "string"
            },
            "None": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                oraison: "string"
            },
            "Sexte": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                oraison: "string"
            },
            "Vepres": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                antienne_magnificat: "string",
                cantique_mariale: { reference: "string", titre: "string", texte: "string" },
                intercession: "string",
                notre_pere: "string",
                oraison: "string"
            }
        };

        async function fetchPrayers() {
            const dateInput = document.getElementById('dateInput').value;
            const zone = document.getElementById('zoneInput').value;
            const resultsDiv = document.getElementById('results');
            
            if (!dateInput) {
                resultsDiv.innerHTML = `<div class="alert alert-warning">Veuillez sélectionner une date.</div>`;
                return;
            }
            
            console.log("Début de la récupération des données pour:", dateInput, zone);

            resultsDiv.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">Récupération des données...</p>
                </div>
            `;

            try {
                // 1. Création des onglets
                let tabsHTML = `<ul class="nav nav-tabs mb-3" id="prayersTab" role="tablist">`;
                let tabContentHTML = `<div class="tab-content" id="prayersTabContent">`;

                Object.keys(PRAYER_STRUCTURE).forEach((prayerName, index) => {
                    tabsHTML += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${index === 0 ? 'active' : ''}" 
                                    id="${prayerName}-tab" data-bs-toggle="tab" 
                                    data-bs-target="#${prayerName}" type="button">
                                ${prayerName}
                            </button>
                        </li>
                    `;
                    tabContentHTML += `
                        <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                             id="${prayerName}" role="tabpanel">
                            <div class="prayer-section" id="${prayerName}-content"></div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = tabsHTML + `</ul>` + tabContentHTML + `</div>`;

                // 2. Récupération des données pour chaque prière
                console.log("Structure des onglets créée");

                for (const [prayerName, structure] of Object.entries(PRAYER_STRUCTURE)) {
                    const endpoint = `${prayerName.toLowerCase()}/${dateInput}/${zone}`;
                    const contentDiv = document.getElementById(`${prayerName}-content`);
                    
                    console.log(`Tentative de récupération pour ${prayerName}...`);

                    try {
                        const response = await fetch(`https://api.aelf.org/v1/${endpoint}`);
                        console.log(`Réponse pour ${prayerName}:`, response.status);
                        
                        if (!response.ok) {
                            console.warn(`Aucune donnée pour ${prayerName}`);
                            contentDiv.innerHTML = `<p class="text-muted">Pas de données disponibles</p>`;
                            continue;
                        }

                        const data = await response.json();
                        console.log(`Données reçues pour ${prayerName}:`, data);

                        contentDiv.innerHTML = formatPrayerData(prayerName, data, structure);
                    } catch (error) {
                        console.error(`Erreur pour ${prayerName}:`, error);
                        contentDiv.innerHTML = `<p class="text-muted">Erreur de chargement</p>`;
                    }
                }

            } catch (error) {
                console.error("Erreur globale:", error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Erreur globale: ${error.message}
                    </div>
                `;
            }
        }

        function formatPrayerData(prayerName, data, structure) {
            console.log(`Formatage des données pour ${prayerName}`, data);
            
            let html = `<h3 class="prayer-title">${prayerName}</h3>`;
            
            if (!data || typeof data !== 'object') {
                return html + `<p>Aucune donnée disponible</p>`;
            }

            // Correction clé : accéder aux données via la clé de la prière (ex: data.complies)
            const prayerData = data[prayerName.toLowerCase()] || data;
            
            if (!prayerData) {
                return html + `<p>Structure de données inattendue</p>`;
            }

            // Fonction pour traiter le texte HTML en toute sécurité
            const processHtmlContent = (content) => {
                if (!content) return '';

                // Utilisation de DOMPurify pour nettoyer le contenu HTML
                return DOMPurify.sanitize(content, {
                    ALLOWED_TAGS: ['u', 'br', 'p', 'span', 'em', 'strong'],
                    ALLOWED_ATTR: ['class']
                });
                
                // Convertit les sauts de ligne en <br> si ce n'est pas déjà du HTML
                if (!/<[a-z][\s\S]*>/i.test(content)) {
                    content = content.replace(/\n/g, '<br>');
                }
                
                // Protection contre XSS tout en conservant les balises de mise en forme
                const allowedTags = {
                    'u': true,
                    'br': true,
                    'p': true,
                    'span': ['class'],
                    'em': true,
                    'strong': true
                };
                
                // Simple sanitizer (pour une protection complète, utilisez DOMPurify)
                return content.replace(/<\/?([a-z]+)([^>]*)>/gi, (match, tag, attrs) => {
                    if (!allowedTags[tag.toLowerCase()]) return '';
                    
                    // Gestion des attributs autorisés
                    let cleanAttrs = '';
                    if (allowedTags[tag] === true || (allowedTags[tag] && allowedTags[tag].length === 0)) {
                        // Pas d'attributs ou tous autorisés
                        cleanAttrs = attrs;
                    } else {
                        // Filtre les attributs spécifiques
                        const allowedAttrs = allowedTags[tag];
                        cleanAttrs = attrs.replace(/(\w+)=(["'])(.*?)\2/g, (m, attr, quote, value) => {
                            return allowedAttrs.includes(attr) ? `${attr}=${quote}${value}${quote}` : '';
                        });
                    }
                    
                    return `<${tag}${cleanAttrs}>`;
                });
            };

            for (const [key, expectedType] of Object.entries(structure)) {
                if (!prayerData[key]) {
                    console.log(`Champ ${key} non trouvé`);
                    continue;
                }
                
                html += `<div class="mb-4">`;
                html += `<h4 class="prayer-subtitle">${key.replace(/_/g, ' ').toUpperCase()}</h4>`;
                
                if (typeof expectedType === 'string') {
                    // Affiche le texte AVEC les balises autorisées
                    html += processHtmlContent(prayerData[key]);
                }
                else if (typeof expectedType === 'object' && prayerData[key]) {
                    if (prayerData[key].reference) {
                        html += `<p class="reference">${processHtmlContent(prayerData[key].reference)}</p>`;
                    }
                    if (prayerData[key].titre) {
                        html += `<h5>${processHtmlContent(prayerData[key].titre)}</h5>`;
                    }
                    if (prayerData[key].texte) {
                        // Nettoyage des balises HTML indésirables
                        html += `<div class="verse">${processHtmlContent(prayerData[key].texte)}</div>`;
                    }
                }
                
                html += `</div>`;
            }
            
            return html || `<p>Aucun détail disponible pour cette prière</p>`;
        }
        
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>