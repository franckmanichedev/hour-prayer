<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prieres des Heures (AELF)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
        }
        
        body { 
            background-color: var(--light-color); 
            font-family: 'Georgia', serif;
            padding-top: 1rem;
        }
        
        .container { 
            max-width: 100%;
            padding: 0 15px;
        }
        
        .card { 
            border-radius: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        /* Navigation tabs */
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
        }
        
        .nav-tabs .nav-link { 
            color: var(--secondary-color); 
            font-weight: 500; 
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .nav-tabs .nav-link.active { 
            color: var(--primary-color); 
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* Prayer content */
        .prayer-section { 
            padding: 1rem; 
            background: white; 
            border-radius: 0 0 15px 15px; 
            font-size: 0.95rem;
        }
        
        .prayer-title { 
            color: var(--primary-color); 
            margin-bottom: 1rem; 
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .prayer-subtitle { 
            color: var(--secondary-color); 
            font-size: 1rem; 
            margin: 0.5rem 0;
        }
        
        .verse { 
            font-style: italic; 
            color: var(--secondary-color); 
            margin-left: 1rem;
            font-size: 0.9rem;
        }
        
        .reference { 
            color: #28a745; 
            font-size: 0.85rem;
        }
        
        /* Form elements */
        .form-control, .form-select {
            font-size: 0.9rem;
            padding: 0.375rem 0.75rem;
        }
        
        .btn {
            padding: 0.375rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .card-header {
                padding: 1rem;
            }
            
            .d-flex {
                flex-direction: column;
                gap: 0.5rem !important;
            }
            
            .d-flex > * {
                width: 100% !important;
            }
            
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .prayer-section {
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 0 10px;
            }
            
            .card {
                border-radius: 10px;
            }
            
            .prayer-title {
                font-size: 1.1rem;
            }
            
            .verse {
                margin-left: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container py-3 py-md-5">
        <div class="card shadow">
            <div class="card-header bg-white text-center py-3 py-md-4">
                <h1 class="h4 h3-md">Prieres des Heures (AELF)</h1>
                <div class="d-flex flex-column flex-md-row justify-content-center gap-2 gap-md-3 mt-2 mt-md-3">
                    <input type="date" id="dateInput" class="form-control">
                    <select id="zoneInput" class="form-select">
                        <option value="afrique">Afrique</option>
                        <option value="france">France</option>
                    </select>
                    <button onclick="fetchPrayers()" class="btn btn-primary">Afficher</button>
                </div>
            </div>
            <div class="card-body p-2 p-md-3">
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Structure des données attendues pour chaque prière
        const PRAYER_STRUCTURE = {
            "Complies": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                cantique_symeon: { reference: "string", titre: "string", texte: "string" },
                oraison: "string",
                benediction: "string",
                hymne_mariale: { titre: "string", texte: "string" }
            },
            "Laudes": {
                introduction: "string",
                antienne_invitatoire: "string",
                psaume_invitatoire: { reference: "string", texte: "string" },
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                antienne_zacharie: "string",
                cantique_zacharie: { reference: "string", titre: "string", texte: "string" },
                intercession: "string",
                oraison: "string",
                notre_pere: "string"
            },
            "None": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                oraison: "string"
            },
            "Sexte": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                oraison: "string"
            },
            "Vepres": {
                introduction: "string",
                hymne: { titre: "string", texte: "string" },
                antienne_1: "string",
                psaume_1: { reference: "string", texte: "string" },
                antienne_2: "string",
                psaume_2: { reference: "string", texte: "string" },
                antienne_3: "string",
                psaume_3: { reference: "string", texte: "string" },
                pericope: { reference: "string", texte: "string" },
                repons: "string",
                antienne_magnificat: "string",
                cantique_mariale: { reference: "string", titre: "string", texte: "string" },
                intercession: "string",
                notre_pere: "string",
                oraison: "string"
            }
        };

        async function fetchPrayers() {
            const dateInput = document.getElementById('dateInput').value;
            const zone = document.getElementById('zoneInput').value;
            const resultsDiv = document.getElementById('results');
            
            if (!dateInput) {
                resultsDiv.innerHTML = `<div class="alert alert-warning">Veuillez sélectionner une date.</div>`;
                return;
            }
            
            console.log("Début de la récupération des données pour:", dateInput, zone);

            resultsDiv.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2">Récupération des données...</p>
                </div>
            `;

            try {
                // 1. Création des onglets
                let tabsHTML = `<ul class="nav nav-tabs mb-3" id="prayersTab" role="tablist">`;
                let tabContentHTML = `<div class="tab-content" id="prayersTabContent">`;

                Object.keys(PRAYER_STRUCTURE).forEach((prayerName, index) => {
                    tabsHTML += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${index === 0 ? 'active' : ''}" 
                                    id="${prayerName}-tab" data-bs-toggle="tab" 
                                    data-bs-target="#${prayerName}" type="button">
                                ${prayerName}
                            </button>
                        </li>
                    `;
                    tabContentHTML += `
                        <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                             id="${prayerName}" role="tabpanel">
                            <div class="prayer-section" id="${prayerName}-content"></div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = tabsHTML + `</ul>` + tabContentHTML + `</div>`;

                // 2. Récupération des données pour chaque prière
                console.log("Structure des onglets créée");

                for (const [prayerName, structure] of Object.entries(PRAYER_STRUCTURE)) {
                    const endpoint = `${prayerName.toLowerCase()}/${dateInput}/${zone}`;
                    const contentDiv = document.getElementById(`${prayerName}-content`);
                    
                    console.log(`Tentative de récupération pour ${prayerName}...`);

                    try {
                        const response = await fetch(`https://api.aelf.org/v1/${endpoint}`);
                        console.log(`Réponse pour ${prayerName}:`, response.status);
                        
                        if (!response.ok) {
                            console.warn(`Aucune donnée pour ${prayerName}`);
                            contentDiv.innerHTML = `<p class="text-muted">Pas de données disponibles</p>`;
                            continue;
                        }

                        const data = await response.json();
                        console.log(`Données reçues pour ${prayerName}:`, data);

                        contentDiv.innerHTML = formatPrayerData(prayerName, data, structure);
                    } catch (error) {
                        console.error(`Erreur pour ${prayerName}:`, error);
                        contentDiv.innerHTML = `<p class="text-muted">Erreur de chargement</p>`;
                    }
                }

            } catch (error) {
                console.error("Erreur globale:", error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        Erreur globale: ${error.message}
                    </div>
                `;
            }
        }

        function formatPrayerData(prayerName, data, structure) {
            console.log(`Formatage des données pour ${prayerName}`, data);
            
            let html = `<h3 class="prayer-title">${prayerName}</h3>`;
            
            if (!data || typeof data !== 'object') {
                return html + `<p>Aucune donnée disponible</p>`;
            }

            // Correction clé : accéder aux données via la clé de la prière (ex: data.complies)
            const prayerData = data[prayerName.toLowerCase()] || data;
            
            if (!prayerData) {
                return html + `<p>Structure de données inattendue</p>`;
            }

            for (const [key, expectedType] of Object.entries(structure)) {
                if (!prayerData[key]) {
                    console.log(`Champ ${key} non trouvé`);
                    continue;
                }
                
                html += `<div class="mb-4">`;
                html += `<h4 class="prayer-subtitle">${key.replace(/_/g, ' ').toUpperCase()}</h4>`;
                
                if (typeof expectedType === 'string') {
                    html += `<p>${prayerData[key]}</p>`;
                } 
                else if (typeof expectedType === 'object' && prayerData[key]) {
                    if (prayerData[key].reference) {
                        html += `<p class="reference">${prayerData[key].reference}</p>`;
                    }
                    if (prayerData[key].titre) {
                        html += `<h5>${prayerData[key].titre}</h5>`;
                    }
                    if (prayerData[key].texte) {
                        // Nettoyage des balises HTML indésirables
                        let texte = prayerData[key].texte.replace(/<[^>]*>/g, '');
                        html += `<div class="verse">${texte.replace(/\n/g, '<br>')}</div>`;
                    }
                }
                
                html += `</div>`;
            }
            
            return html || `<p>Aucun détail disponible pour cette prière</p>`;
        }
        
        document.getElementById('dateInput').valueAsDate = new Date();
    </script>
</body>
</html>